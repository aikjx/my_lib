<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦»çº¿ç‰ˆå‡ ä½•å› å­å¯è§†åŒ– - ç«‹ä½“è§’ç§¯åˆ†æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            color: white;
        }
        
        #canvas {
            display: block;
            cursor: grab;
            transition: cursor 0.2s;
        }
        
        #canvas:active {
            cursor: grabbing;
        }
        
        .ui-panel {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }
        
        #info-panel {
            top: 30px;
            left: 30px;
            width: 420px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        #controls-panel {
            top: 30px;
            right: 30px;
            width: 320px;
        }
        
        #math-panel {
            bottom: 30px;
            left: 30px;
            width: 600px;
            max-height: 40vh;
            overflow-y: auto;
        }
        
        #stats-panel {
            bottom: 30px;
            right: 30px;
            width: 280px;
        }
        
        .panel-title {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .control-group {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .slider-container {
            margin: 10px 0;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            margin: 8px 4px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .math-formula {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .math-formula.active {
            background: rgba(102, 126, 234, 0.2);
            border-left-color: #feca57;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #feca57);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .highlight {
            color: #feca57;
            font-weight: bold;
        }
        
        .warning {
            color: #ff6b6b;
            font-weight: bold;
        }
        
        .success {
            color: #51cf66;
            font-weight: bold;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        
        .checkbox-container input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        #fps-counter {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .pulsing {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="fps-counter">FPS: <span id="fps-value">60</span></div>
    
    <!-- ä¿¡æ¯é¢æ¿ -->
    <div id="info-panel" class="ui-panel">
        <div class="panel-title">ğŸŒŒ å‡ ä½•å› å­æ¨å¯¼å¯è§†åŒ–</div>
        <div id="current-step-info">
            <h4>å½“å‰æ­¥éª¤: <span id="current-step" class="highlight">åˆå§‹åŒ–</span></h4>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <p id="step-description">æ­£åœ¨è®¾ç½®ä¸‰ç»´ç©ºé—´ä¸­çš„çƒå¯¹ç§°å‘æ•£åœºå’Œç«‹ä½“è§’ç§¯åˆ†å¯è§†åŒ–...</p>
        </div>
        
        <div class="control-group">
            <h4>ğŸ“Š ç§¯åˆ†è¿›åº¦ç›‘æ§</h4>
            <div class="stat-item">
                <span>ç§¯åˆ†å€¼:</span>
                <span id="integral-value" class="highlight">0.000</span>
            </div>
            <div class="stat-item">
                <span>ç†è®ºå€¼ Ï€Â²:</span>
                <span class="success">9.870</span>
            </div>
            <div class="stat-item">
                <span>å‡ ä½•å› å­:</span>
                <span id="geometric-factor" class="highlight">0.000</span>
            </div>
            <div class="stat-item">
                <span>è¯¯å·®:</span>
                <span id="error-value" class="warning">100%</span>
            </div>
        </div>
        
        <div class="control-group">
            <h4>ğŸ¯ ç‰©ç†è§£é‡Š</h4>
            <p id="physics-explanation">
                ç«‹ä½“è§’ç§¯åˆ† âˆ«sin Î¸ dÎ© è¡¨ç¤ºçƒå¯¹ç§°åœºåœ¨äºŒç»´å¹³é¢ä¸Šçš„æŠ•å½±æ€»å’Œã€‚
                è¿™ä¸ªç§¯åˆ†çš„ç»“æœå†³å®šäº†ä»ä¸‰ç»´åˆ°äºŒç»´çš„å‡ ä½•ä¿®æ­£å› å­ã€‚
            </p>
        </div>
    </div>
    
    <!-- æ§åˆ¶é¢æ¿ -->
    <div id="controls-panel" class="ui-panel">
        <div class="panel-title">ğŸ® äº¤äº’æ§åˆ¶</div>
        
        <div class="control-group">
            <button class="button" onclick="startSimulation()">â–¶ï¸ å¼€å§‹æ¨¡æ‹Ÿ</button>
            <button class="button" onclick="pauseSimulation()">â¸ï¸ æš‚åœ</button>
            <button class="button" onclick="resetSimulation()">ğŸ”„ é‡ç½®</button>
        </div>
        
        <div class="control-group">
            <h4>ç§¯åˆ†å‚æ•°æ§åˆ¶</h4>
            <div class="slider-container">
                <label>Î¸ ç§¯åˆ†ä¸Šé™: <span id="theta-limit">Ï€</span></label>
                <input type="range" class="slider" id="theta-slider" min="0" max="180" value="180" 
                       oninput="updateThetaLimit(this.value)">
            </div>
            <div class="slider-container">
                <label>Ï† ç§¯åˆ†ä¸Šé™: <span id="phi-limit">2Ï€</span></label>
                <input type="range" class="slider" id="phi-slider" min="0" max="360" value="360" 
                       oninput="updatePhiLimit(this.value)">
            </div>
            <div class="slider-container">
                <label>ç§¯åˆ†ç²¾åº¦: <span id="precision">100</span></label>
                <input type="range" class="slider" id="precision-slider" min="10" max="500" value="100" 
                       oninput="updatePrecision(this.value)">
            </div>
        </div>
        
        <div class="control-group">
            <h4>å¯è§†åŒ–é€‰é¡¹</h4>
            <div class="checkbox-container">
                <input type="checkbox" id="show-field-lines" checked onchange="toggleFieldLines()">
                <label>æ˜¾ç¤ºåœºçº¿</label>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="show-integration-region" checked onchange="toggleIntegrationRegion()">
                <label>æ˜¾ç¤ºç§¯åˆ†åŒºåŸŸ</label>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="show-projection-plane" checked onchange="toggleProjectionPlane()">
                <label>æ˜¾ç¤ºæŠ•å½±å¹³é¢</label>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="show-particles" checked onchange="toggleParticles()">
                <label>æ˜¾ç¤ºç²’å­ç³»ç»Ÿ</label>
            </div>
        </div>
        
        <div class="control-group">
            <h4>åŠ¨ç”»æ§åˆ¶</h4>
            <div class="slider-container">
                <label>æ—‹è½¬é€Ÿåº¦: <span id="rotation-speed">1.0</span></label>
                <input type="range" class="slider" id="rotation-slider" min="0" max="3" value="1" step="0.1" 
                       oninput="updateRotationSpeed(this.value)">
            </div>
            <div class="slider-container">
                <label>åœºå¼ºå¯è§†åŒ–: <span id="field-intensity">1.0</span></label>
                <input type="range" class="slider" id="field-slider" min="0.1" max="3" value="1" step="0.1" 
                       oninput="updateFieldIntensity(this.value)">
            </div>
        </div>
    </div>
    
    <!-- æ•°å­¦å…¬å¼é¢æ¿ -->
    <div id="math-panel" class="ui-panel">
        <div class="panel-title">ğŸ“ æ•°å­¦æ¨å¯¼è¿‡ç¨‹</div>
        <div id="math-formulas">
            <div class="math-formula" id="formula-1">
                <strong>æ­¥éª¤1: ç«‹ä½“è§’ç§¯åˆ†è®¾ç½®</strong><br>
                æˆ‘ä»¬éœ€è¦è®¡ç®—çƒå¯¹ç§°åœºåœ¨äºŒç»´å¹³é¢ä¸Šçš„æŠ•å½±ï¼š<br>
                âˆ« sin Î¸ dÎ© = âˆ«â‚€Â²Ï€ dÏ† âˆ«â‚€Ï€ sin Î¸ Â· sin Î¸ dÎ¸
            </div>
            
            <div class="math-formula" id="formula-2">
                <strong>æ­¥éª¤2: åˆ†ç¦»å˜é‡ç§¯åˆ†</strong><br>
                å°† Ï† å’Œ Î¸ ç§¯åˆ†åˆ†ç¦»ï¼š<br>
                = âˆ«â‚€Â²Ï€ dÏ† âˆ«â‚€Ï€ sinÂ²Î¸ dÎ¸ = 2Ï€ âˆ«â‚€Ï€ sinÂ²Î¸ dÎ¸
            </div>
            
            <div class="math-formula" id="formula-3">
                <strong>æ­¥éª¤3: è®¡ç®— sinÂ²Î¸ ç§¯åˆ†</strong><br>
                ä½¿ç”¨ç§¯åˆ†å…¬å¼ âˆ«â‚€Ï€ sinÂ²Î¸ dÎ¸ = Ï€/2ï¼š<br>
                2Ï€ âˆ«â‚€Ï€ sinÂ²Î¸ dÎ¸ = 2Ï€ Â· Ï€/2 = Ï€Â²
            </div>
            
            <div class="math-formula" id="formula-4">
                <strong>æ­¥éª¤4: å‡ ä½•å› å­æ¨å¯¼</strong><br>
                å°†ç§¯åˆ†ç»“æœè½¬æ¢ä¸ºå‡ ä½•å› å­ï¼š<br>
                å‡ ä½•å› å­ = (Ï€Â²/2Ï€) Â· (4Ï€/Ï€Â²) = (Ï€Â² Â· 4Ï€)/(2Ï€ Â· Ï€Â²) = 4Ï€/2Ï€ = 2
            </div>
            
            <div class="math-formula warning" id="formula-5">
                <strong>âš ï¸ é—®é¢˜åˆ†æ</strong><br>
                è¿™ä¸ªæ¨å¯¼å­˜åœ¨æ¦‚å¿µé—®é¢˜ï¼š<br>
                â€¢ ç§¯åˆ†ç»“æœ Ï€Â² æœ‰ç‰¹å®šçš„ç‰©ç†æ„ä¹‰ï¼Œä¸åº”éšæ„è¿›è¡Œé‡çº²è½¬æ¢<br>
                â€¢ å‡ ä½•å› å­åº”è¯¥æ˜¯æ— é‡çº²æ•°ï¼Œä¸”æœ‰æ˜ç¡®çš„ç‰©ç†æ¥æº<br>
                â€¢ æ ‡å‡†ç‰©ç†ä¸­çš„å‡ ä½•å› å­é€šå¸¸æ¥è‡ªç«‹ä½“è§’æ¯”å€¼æˆ–å¯¹ç§°æ€§è€ƒè™‘
            </div>
        </div>
    </div>
    
    <!-- ç»Ÿè®¡é¢æ¿ -->
    <div id="stats-panel" class="ui-panel">
        <div class="panel-title">ğŸ“ˆ å®æ—¶ç»Ÿè®¡</div>
        <div id="performance-stats">
            <div class="stat-item">
                <span>æ¸²æŸ“å¯¹è±¡:</span>
                <span id="object-count" class="highlight">0</span>
            </div>
            <div class="stat-item">
                <span>ç²’å­æ•°:</span>
                <span id="particle-count" class="highlight">1000</span>
            </div>
            <div class="stat-item">
                <span>åœºçº¿æ•°:</span>
                <span id="field-line-count" class="highlight">50</span>
            </div>
            <div class="stat-item">
                <span>å¸§æ—¶é—´:</span>
                <span id="frame-time" class="highlight">16ms</span>
            </div>
        </div>
        
        <div class="control-group">
            <h4>ğŸ”¬ æ•°å€¼éªŒè¯</h4>
            <div class="stat-item">
                <span>æ•°å€¼ç§¯åˆ†:</span>
                <span id="numerical-integral" class="highlight">0.000</span>
            </div>
            <div class="stat-item">
                <span>è§£æè§£:</span>
                <span class="success">9.870</span>
            </div>
            <div class="stat-item">
                <span>ç›¸å¯¹è¯¯å·®:</span>
                <span id="relative-error" class="warning">100%</span>
            </div>
        </div>
    </div>

    <!-- å†…åµŒThree.jsç®€åŒ–ç‰ˆæœ¬ -->
    <script>
        // ç®€åŒ–çš„Three.jsæ ¸å¿ƒåŠŸèƒ½
        const THREE = {
            Scene: function() {
                this.children = [];
                this.background = null;
                this.fog = null;
                this.add = function(object) { this.children.push(object); };
                this.remove = function(object) { 
                    const index = this.children.indexOf(object);
                    if (index > -1) this.children.splice(index, 1);
                };
            },
            
            PerspectiveCamera: function(fov, aspect, near, far) {
                this.fov = fov;
                this.aspect = aspect;
                this.near = near;
                this.far = far;
                this.position = { x: 0, y: 0, z: 0, set: function(x, y, z) { this.x = x; this.y = y; this.z = z; } };
                this.lookAt = function(target) { /* ç®€åŒ–å®ç° */ };
                this.updateProjectionMatrix = function() { /* ç®€åŒ–å®ç° */ };
            },
            
            WebGLRenderer: function(params) {
                this.domElement = params.canvas;
                this.shadowMap = { enabled: false, type: null };
                this.outputEncoding = null;
                this.toneMapping = null;
                this.toneMappingExposure = 1;
                
                this.setSize = function(width, height) {
                    this.domElement.width = width;
                    this.domElement.height = height;
                };
                
                this.render = function(scene, camera) {
                    // ç®€åŒ–çš„æ¸²æŸ“å®ç°
                    const ctx = this.domElement.getContext('2d');
                    if (ctx) {
                        ctx.fillStyle = '#0a0a1a';
                        ctx.fillRect(0, 0, this.domElement.width, this.domElement.height);
                        
                        // ç»˜åˆ¶ç®€åŒ–çš„3Dåœºæ™¯
                        this.renderSimplified(ctx, scene, camera);
                    }
                };
                
                this.renderSimplified = function(ctx, scene, camera) {
                    // ç»˜åˆ¶ä¸­å¿ƒçš„è´¨é‡ç‚¹
                    ctx.fillStyle = '#ff4444';
                    ctx.beginPath();
                    ctx.arc(200, 300, 20, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    ctx.fillStyle = '#4444ff';
                    ctx.beginPath();
                    ctx.arc(600, 300, 15, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // ç»˜åˆ¶åœºçº¿
                    if (window.showFieldLines) {
                        ctx.strokeStyle = '#ffaa00';
                        ctx.lineWidth = 2;
                        for (let i = 0; i < 20; i++) {
                            const angle = (i / 20) * 2 * Math.PI;
                            const startX = 200 + Math.cos(angle) * 25;
                            const startY = 300 + Math.sin(angle) * 25;
                            const endX = 200 + Math.cos(angle) * 100;
                            const endY = 300 + Math.sin(angle) * 100;
                            
                            ctx.beginPath();
                            ctx.moveTo(startX, startY);
                            ctx.lineTo(endX, endY);
                            ctx.stroke();
                        }
                    }
                    
                    // ç»˜åˆ¶æŠ•å½±å¹³é¢
                    if (window.showProjectionPlane) {
                        ctx.strokeStyle = '#44ff44';
                        ctx.lineWidth = 3;
                        ctx.setLineDash([5, 5]);
                        ctx.beginPath();
                        ctx.moveTo(100, 300);
                        ctx.lineTo(700, 300);
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }
                    
                    // ç»˜åˆ¶ç§¯åˆ†åŒºåŸŸ
                    if (window.showIntegrationRegion && window.integralProgress > 0) {
                        ctx.fillStyle = 'rgba(255, 170, 0, 0.3)';
                        const radius = (window.integralProgress / 100) * 80;
                        ctx.beginPath();
                        ctx.arc(200, 300, radius, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                };
                
                this.dispose = function() { /* æ¸…ç†èµ„æº */ };
            },
            
            Color: function(color) {
                this.r = 0; this.g = 0; this.b = 0;
                if (typeof color === 'number') {
                    this.setHex(color);
                }
                this.setHex = function(hex) {
                    this.r = ((hex >> 16) & 255) / 255;
                    this.g = ((hex >> 8) & 255) / 255;
                    this.b = (hex & 255) / 255;
                };
            },
            
            Vector3: function(x, y, z) {
                this.x = x || 0;
                this.y = y || 0;
                this.z = z || 0;
                this.set = function(x, y, z) { this.x = x; this.y = y; this.z = z; return this; };
                this.clone = function() { return new THREE.Vector3(this.x, this.y, this.z); };
                this.add = function(v) { this.x += v.x; this.y += v.y; this.z += v.z; return this; };
                this.multiplyScalar = function(s) { this.x *= s; this.y *= s; this.z *= s; return this; };
                this.normalize = function() {
                    const length = Math.sqrt(this.x * this.x + this.y * this.y + this.z * this.z);
                    if (length > 0) {
                        this.x /= length; this.y /= length; this.z /= length;
                    }
                    return this;
                };
            },
            
            Group: function() {
                this.children = [];
                this.position = new THREE.Vector3();
                this.rotation = { x: 0, y: 0, z: 0 };
                this.visible = true;
                this.add = function(object) { this.children.push(object); };
            },
            
            // ç®€åŒ–çš„æè´¨å’Œå‡ ä½•ä½“
            SphereGeometry: function(radius, widthSegments, heightSegments) {
                this.radius = radius;
                this.widthSegments = widthSegments;
                this.heightSegments = heightSegments;
            },
            
            MeshBasicMaterial: function(params) {
                this.color = params.color || 0xffffff;
                this.transparent = params.transparent || false;
                this.opacity = params.opacity || 1;
                this.wireframe = params.wireframe || false;
            },
            
            Mesh: function(geometry, material) {
                this.geometry = geometry;
                this.material = material;
                this.position = new THREE.Vector3();
                this.rotation = { x: 0, y: 0, z: 0 };
                this.visible = true;
            }
        };
        
        // å…¨å±€å˜é‡
        let scene, camera, renderer;
        let animationId, isSimulating = false;
        let integralProgress = 0, rotationSpeed = 1, fieldIntensity = 1;
        let thetaLimit = Math.PI, phiLimit = 2 * Math.PI, precision = 100;
        let frameCount = 0, lastTime = Date.now();
        
        // æ˜¾ç¤ºæ§åˆ¶å˜é‡
        window.showFieldLines = true;
        window.showProjectionPlane = true;
        window.showIntegrationRegion = true;
        window.showParticles = true;
        window.integralProgress = 0;
        
        // åˆå§‹åŒ–åœºæ™¯
        function initScene() {
            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a1a);
            
            // åˆ›å»ºç›¸æœº
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(12, 8, 12);
            
            // åˆ›å»ºæ¸²æŸ“å™¨
            const canvas = document.getElementById('canvas');
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            // å¼€å§‹æ¸²æŸ“å¾ªç¯
            animate();
            
            updateStepInfo(0, "åˆå§‹åŒ–å®Œæˆ", "ä¸‰ç»´çƒå¯¹ç§°å‘æ•£åœºå’Œç«‹ä½“è§’ç§¯åˆ†å¯è§†åŒ–å·²å‡†å¤‡å°±ç»ª");
        }
        
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // è®¡ç®—FPS
            frameCount++;
            const currentTime = Date.now();
            if (currentTime - lastTime >= 1000) {
                const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                document.getElementById('fps-value').textContent = fps;
                document.getElementById('frame-time').textContent = Math.round(1000/fps) + 'ms';
                frameCount = 0;
                lastTime = currentTime;
            }
            
            if (isSimulating) {
                // æ›´æ–°ç§¯åˆ†å¯è§†åŒ–
                updateIntegrationVisualization();
                
                // æ›´æ–°ç§¯åˆ†è®¡ç®—
                updateIntegralCalculation();
            }
            
            renderer.render(scene, camera);
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updatePerformanceStats();
        }
        
        function updateIntegrationVisualization() {
            // ç®€åŒ–çš„ç§¯åˆ†å¯è§†åŒ–æ›´æ–°
            window.integralProgress = integralProgress;
        }
        
        function updateIntegralCalculation() {
            // æ•°å€¼ç§¯åˆ†è®¡ç®—
            const thetaSteps = Math.floor(precision);
            const phiSteps = Math.floor(precision);
            let numericalIntegral = 0;
            
            for (let i = 0; i < thetaSteps; i++) {
                for (let j = 0; j < phiSteps; j++) {
                    const theta = (i / thetaSteps) * thetaLimit;
                    const phi = (j / phiSteps) * phiLimit;
                    
                    const dTheta = thetaLimit / thetaSteps;
                    const dPhi = phiLimit / phiSteps;
                    
                    numericalIntegral += Math.sin(theta) * Math.sin(theta) * dTheta * dPhi;
                }
            }
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('integral-value').textContent = numericalIntegral.toFixed(3);
            document.getElementById('numerical-integral').textContent = numericalIntegral.toFixed(3);
            
            const theoreticalValue = Math.PI * Math.PI;
            const error = Math.abs(numericalIntegral - theoreticalValue) / theoreticalValue * 100;
            document.getElementById('error-value').textContent = error.toFixed(1) + '%';
            document.getElementById('relative-error').textContent = error.toFixed(1) + '%';
            
            // è®¡ç®—å‡ ä½•å› å­
            const geometricFactor = numericalIntegral > 0 ? (numericalIntegral / (2 * Math.PI)) * (4 * Math.PI / numericalIntegral) : 0;
            document.getElementById('geometric-factor').textContent = geometricFactor.toFixed(3);
        }
        
        function updatePerformanceStats() {
            document.getElementById('object-count').textContent = scene.children.length;
            document.getElementById('particle-count').textContent = '1000';
            document.getElementById('field-line-count').textContent = '50';
        }
        
        // æ§åˆ¶å‡½æ•°
        function startSimulation() {
            isSimulating = true;
            updateStepInfo(25, "å¼€å§‹ç§¯åˆ†è®¡ç®—", "æ­£åœ¨æ‰§è¡Œç«‹ä½“è§’ç§¯åˆ† âˆ«sin Î¸ dÎ© çš„æ•°å€¼è®¡ç®—");
            highlightFormula(1);
        }
        
        function pauseSimulation() {
            isSimulating = false;
            updateStepInfo(50, "æ¨¡æ‹Ÿå·²æš‚åœ", "å¯ä»¥è°ƒèŠ‚å‚æ•°è§‚å¯Ÿä¸åŒæ¡ä»¶ä¸‹çš„ç§¯åˆ†ç»“æœ");
        }
        
        function resetSimulation() {
            isSimulating = false;
            integralProgress = 0;
            
            // é‡ç½®æ‰€æœ‰æ»‘å—
            document.getElementById('theta-slider').value = 180;
            document.getElementById('phi-slider').value = 360;
            document.getElementById('precision-slider').value = 100;
            
            updateThetaLimit(180);
            updatePhiLimit(360);
            updatePrecision(100);
            
            updateStepInfo(0, "é‡ç½®å®Œæˆ", "æ‰€æœ‰å‚æ•°å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€");
            highlightFormula(0);
        }
        
        function updateThetaLimit(value) {
            thetaLimit = (parseFloat(value) / 180) * Math.PI;
            document.getElementById('theta-limit').textContent = value + 'Â°';
            integralProgress = (parseFloat(value) / 180) * 100;
            updateProgressBar();
        }
        
        function updatePhiLimit(value) {
            phiLimit = (parseFloat(value) / 180) * Math.PI;
            document.getElementById('phi-limit').textContent = value + 'Â°';
        }
        
        function updatePrecision(value) {
            precision = parseFloat(value);
            document.getElementById('precision').textContent = value;
        }
        
        function updateRotationSpeed(value) {
            rotationSpeed = parseFloat(value);
            document.getElementById('rotation-speed').textContent = value;
        }
        
        function updateFieldIntensity(value) {
            fieldIntensity = parseFloat(value);
            document.getElementById('field-intensity').textContent = value;
        }
        
        function toggleFieldLines() {
            window.showFieldLines = document.getElementById('show-field-lines').checked;
        }
        
        function toggleIntegrationRegion() {
            window.showIntegrationRegion = document.getElementById('show-integration-region').checked;
        }
        
        function toggleProjectionPlane() {
            window.showProjectionPlane = document.getElementById('show-projection-plane').checked;
        }
        
        function toggleParticles() {
            window.showParticles = document.getElementById('show-particles').checked;
        }
        
        function updateStepInfo(progress, step, description) {
            document.getElementById('current-step').textContent = step;
            document.getElementById('step-description').textContent = description;
            document.getElementById('progress-fill').style.width = progress + '%';
            
            // æ›´æ–°ç‰©ç†è§£é‡Š
            const explanations = [
                "ç«‹ä½“è§’ç§¯åˆ† âˆ«sin Î¸ dÎ© è¡¨ç¤ºçƒå¯¹ç§°åœºåœ¨äºŒç»´å¹³é¢ä¸Šçš„æŠ•å½±æ€»å’Œã€‚è¿™ä¸ªç§¯åˆ†çš„ç»“æœå†³å®šäº†ä»ä¸‰ç»´åˆ°äºŒç»´çš„å‡ ä½•ä¿®æ­£å› å­ã€‚",
                "æ­£åœ¨è®¡ç®— Ï† æ–¹å‘çš„ç§¯åˆ†ã€‚Ï† ä» 0 åˆ° 2Ï€ çš„ç§¯åˆ†ç»“æœä¸º 2Ï€ï¼Œè¿™åæ˜ äº†çƒå¯¹ç§°æ€§ã€‚",
                "æ­£åœ¨è®¡ç®— Î¸ æ–¹å‘çš„ç§¯åˆ†ã€‚âˆ«â‚€^Ï€ sinÂ²Î¸ dÎ¸ = Ï€/2ï¼Œè¿™æ˜¯å…³é”®çš„å‡ ä½•ç§¯åˆ†ã€‚",
                "ç§¯åˆ†è®¡ç®—å®Œæˆã€‚ç»“æœ Ï€Â² â‰ˆ 9.87ï¼Œä½†å°†å…¶è½¬æ¢ä¸ºå‡ ä½•å› å­ 2 çš„è¿‡ç¨‹å­˜åœ¨æ¦‚å¿µé—®é¢˜ã€‚",
                "å‡ ä½•å› å­æ¨å¯¼å®Œæˆï¼Œä½†éœ€è¦æ³¨æ„è¿™ç§æ¨å¯¼æ–¹æ³•çš„å±€é™æ€§å’Œæ¦‚å¿µé—®é¢˜ã€‚"
            ];
            
            const explanationIndex = Math.floor(progress / 20);
            if (explanations[explanationIndex]) {
                document.getElementById('physics-explanation').textContent = explanations[explanationIndex];
            }
        }
        
        function updateProgressBar() {
            document.getElementById('progress-fill').style.width = integralProgress + '%';
        }
        
        function highlightFormula(index) {
            const formulas = document.querySelectorAll('.math-formula');
            formulas.forEach((formula, i) => {
                formula.classList.remove('active');
                if (i === index) {
                    formula.classList.add('active');
                }
            });
        }
        
        // é¼ æ ‡æ§åˆ¶
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        
        const canvas = document.getElementById('canvas');
        
        canvas.addEventListener('mousedown', (event) => {
            isDragging = true;
            previousMousePosition = { x: event.clientX, y: event.clientY };
        });
        
        canvas.addEventListener('mousemove', (event) => {
            if (isDragging) {
                const deltaMove = {
                    x: event.clientX - previousMousePosition.x,
                    y: event.clientY - previousMousePosition.y
                };
                
                // ç®€åŒ–çš„ç›¸æœºæ§åˆ¶
                console.log('Camera rotation:', deltaMove);
                
                previousMousePosition = { x: event.clientX, y: event.clientY };
            }
        });
        
        canvas.addEventListener('mouseup', () => {
            isDragging = false;
        });
        
        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (event) => {
            switch(event.code) {
                case 'Space':
                    event.preventDefault();
                    isSimulating ? pauseSimulation() : startSimulation();
                    break;
                case 'KeyR':
                    resetSimulation();
                    break;
            }
        });
        
        // çª—å£å¤§å°è°ƒæ•´
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            initScene();
        });
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            if (renderer) {
                renderer.dispose();
            }
        });
    </script>
</body>
</html>